# postgres-lxc

Миграция, репликация и автоматическое резервное копирование Postgresql в контейнере lxc. Выполненное тестовое задание с задокументированными шагами и готовым lxc контейнером (ссылки в конце документа).

Postgresql migration, replication and automated backup in lxc container. Completed test task, with documented steps and finished container (links at the end of the document).

![изображение](https://github.com/cloaksocks/postgres-lxc/assets/157986562/7206f2f7-7aeb-41d5-b76d-d02a413f46fc)


## Задание:

Вам предложена должность администратора Linux для небольшого бизнеса, который владеет сервером, на котором требуется развернуть LXD контейнер с кластером PostgreSQL. Ваша задача включает в себя следующее:
1. Настройка и инициализация LXD на сервере.
    
2. Установка и настройка сервера баз данных PostgreSQL для поддержки приложений компании.
    
3. Реализация механизма резервного копирования сервера баз данных для обеспечения сохранности данных в случае сбоя.
    

## Шаги:

### 1. Настройка и инициализация LXD на сервере:
- Установка LXD с использованием менеджера пакетов.
- Настройка хранилища для контейнеров.
- Инициализация LXD с помощью команды ```lxd init```.
- Настройка сети для LXD.
- Настройка поддержки непривилегированных контейнеров.
- Запуск контейнера на базе OS Ubuntu
  - Подключаем удаленный репозиторий с образами ```lxc remote add ubuntu-minimal https://cloud-images.ubuntu.com/minimal/releases --protocol=simplestreams```
  - Запускаем контейнер lxc ```launch ubuntu-minimal:22.04 container-1```
### 2. Установить и настроить сервер баз данных в LXD контейнере:
- Установите пакет ```postgresql-11```
- Восстановление базы данных из бинарного бэкапа ссылка на бэкап.
- Произведите миграцию базы с 11 на 14 версию PostgreSQL
- Поднимите второй инстанс PostgreSQL 14 на порту 5433
- Настройте во втором инстансе потоковую репликацию через пользователя ```stocks_subscriber``` в режиме master-slave.
- Настройте во втором (slave) инстансе read-only доступ через роль ```stocks_viewer``` к таблице stocks для любого подключаемого из вне IP адреса.
### 3. Реализовать резервное копирование:
- Напишите скрипт для создания резервной копии базы данных в локальный каталог в сжатом виде.
- Реализация ротации резервных копий в соответствии с предложенной политикой хранения:
  -  Сохранение последних 5 резервных копий.
  -  Сохранение одной копии в день за последние 2 дня.
  -  Сохранение одной копии в неделю без ограничений на количество.
- Используйте утилиту cron для запуска скрипта с регулярными интервалами, например, каждый час.
- Протестируйте систему резервного копирования, восстановив файлы резервных копий в локальный каталог.


## Вам необходимо предоставить следующие результаты:

1. LXD instance с настроенными сервисами. (Загрузить образ можно на Google/Yandex диск)
- Подготовить instance можно командой lxc export container-1:
https://drive.google.com/file/d/1OlJ5GHix9cMbClelpUG2ijVM8UW-4xIk/view?usp=sharing

2. Документ, в котором описаны шаги, которые вы предприняли для выполнения задачи:
https://drive.google.com/file/d/1Fdb7bnQznlGRLpiZpbpJjxvr0DA1qLtk/view?usp=sharing

4. Скрипт решения для резервного копирования:
https://drive.google.com/file/d/1WwhrsId28jttSVEvBAVtQ6CA5AR2pOI3/view?usp=sharing
